<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
            padding: 20px; 
        }
        
        .control-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            width: 100%; 
            transition: opacity 0.5s ease;
        }
        
        .btn-large { 
            width: 100%; 
            height: 100px; 
            font-size: 24px; 
            background: var(--blue); 
            color: white; 
            border: none; 
            border-radius: 15px; 
            transition: opacity 0.5s ease;
        }
        
        .btn-sub { 
            padding: 20px; 
            background: #333; 
            color: white; 
            border: 1px solid var(--blue); 
            border-radius: 10px; 
            font-size: 18px; 
        }
        
        /* HUD Styles */
        #remote-hud {
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            gap: 10px;
            font-family: monospace;
            color: #aaa;
            background: rgba(255,255,255,0.05);
            border: 1px solid #444;
            
            font-size: 1rem; 
            padding: 12px;
            border-radius: 12px;
        }
        #remote-hud span { color: var(--white); font-weight: bold; }
        
        /* Disabled State */
        .controls-disabled {
            opacity: 0.3;
            pointer-events: none;
        }
        
        .status-subtext {
            display: block;
            font-size: 0.8rem;
            font-weight: normal;
            margin-top: 5px;
            color: #999;
        }
    </style>
</head>
<body>

    <div class="header-container">
        <span class="app_icon">ðŸ’¬</span>
        <span class="app_title_remote">
            <span style="color: var(--white);">Web</span>Prompter<span class="title-suffix">.app</span>
        </span>
    </div>
    
    <div style="text-align:center;">
        <h3 id="rm-status" style="color:var(--yellow); margin:0;">Connecting...</h3>
        <span id="rm-substatus" class="status-subtext"></span>
    </div>
    
    <div id="remote-hud">
        <span>SPEED: <span id="disp-speed">--</span></span>
        <span>TIME: <span id="disp-time">--:--</span></span>
    </div>

    <button id="playBtn" class="btn-large">START</button>
    
    <div class="control-grid" id="main-controls">
        <button class="btn-sub" onclick="send('speed-up')">Speed +</button>
        <button class="btn-sub" onclick="send('speed-down')">Speed -</button>
        <button class="btn-sub" onclick="send('size-up')">Size +</button>
        <button class="btn-sub" onclick="send('size-down')">Size -</button>
        <button class="btn-sub" onclick="send('mirror')" style="border-color: var(--yellow)">Mirror</button>
        <button class="btn-sub" onclick="send('page-up')" style="border-color: var(--yellow)">Scroll â†‘</button>
    </div>

    <script>
        const targetId = new URLSearchParams(window.location.search).get('remote');
        const peer = new Peer();
        let conn;
        let active = false;
        let isConnected = false;

        // 1. START TIMEOUT IMMEDIATELY (5 Seconds)
        const connectionTimer = setTimeout(() => {
            if (!isConnected) {
                endSession("CONNECTION FAILED");
                document.getElementById('rm-substatus').innerText = "Host not found. Check internet or scan again.";
            }
        }, 5000);

        peer.on('open', () => {
            conn = peer.connect(targetId);
            
            conn.on('open', () => {
                // 2. CONNECTION SUCCESS - CANCEL TIMER
                clearTimeout(connectionTimer);
                isConnected = true;

                document.getElementById('rm-status').innerText = 'CONNECTED';
                document.getElementById('rm-status').style.color = '#2ecc71';
            });
            
            conn.on('close', () => {
                endSession();
            });

            conn.on('data', (data) => {
                if(data.action === 'hud-update') {
                    document.getElementById('disp-speed').innerText = data.speed;
                    document.getElementById('disp-time').innerText = data.time;
                }
                if(data.action === 'close') {
                    endSession();
                }
            });
        });

        // Handle PeerJS Errors (e.g., ID doesn't exist)
        peer.on('error', (err) => {
            clearTimeout(connectionTimer); // Stop the generic timer
            endSession("CONNECTION FAILED"); // Show failed immediately
            console.error(err);
        });

        function send(action) { if(conn) conn.send({action}); }

        document.getElementById('playBtn').onclick = function() {
            active = !active;
            this.innerText = active ? 'STOP' : 'START';
            this.style.background = active ? 'var(--red)' : 'var(--blue)';
            conn.send({action: 'toggle', state: active});
        };
        
        function endSession(msg = 'SESSION ENDED') {
            // Update Text
            const status = document.getElementById('rm-status');
            status.innerText = msg;
            status.style.color = 'var(--red)';
            
            // Only update subtext if it's empty (preserves timeout message)
            const sub = document.getElementById('rm-substatus');
            if(sub.innerText === "") {
                 sub.innerText = 'Please close this tab and scan the new QR code.';
            }
            
            // Disable UI
            document.getElementById('main-controls').classList.add('controls-disabled');
            document.getElementById('playBtn').classList.add('controls-disabled');
            document.getElementById('remote-hud').style.opacity = '0.3';
        }
    </script>

    <footer class="bliz-footer">
        Made by Alex Blizky with <span class="heart">ðŸŽ„</span><br>
        <a href="https://ko-fi.com/blizky" target="_blank" rel="noopener noreferrer">Buy me a Ko-fi</a>
        <img src="/assets/ko-fi.svg" alt="Ko-fi" class="icon-kofi"> 
    </footer>

</body>
</html>
